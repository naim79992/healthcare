<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Prescription Management</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4 text-center">Prescription Management</h2>

  <!-- Navigation -->
  <div class="mb-4 text-end">
    <a href="drug-search.html" class="btn btn-info">üîç Drug Search (RxNav)</a>
  </div>

  <!-- Date Filter -->
  <form id="filterForm" class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="date" id="startDate" class="form-control" required>
    </div>
    <div class="col-md-4">
      <input type="date" id="endDate" class="form-control" required>
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <!-- Prescription Table -->
  <h4>Prescription List</h4>
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Patient</th>
        <th>Age</th>
        <th>Gender</th>
        <th>Diagnosis</th>
        <th>Medicines</th>
        <th>Next Visit</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody id="prescriptionTable"></tbody>
  </table>

  <!-- Day-wise Report -->
  <h4 class="mt-5">Day-wise Prescription Count</h4>
  <table class="table table-bordered table-striped">
    <thead class="table-secondary">
      <tr>
        <th>Day</th>
        <th>Prescription Count</th>
      </tr>
    </thead>
    <tbody id="daywiseReportTable"></tbody>
  </table>

  <!-- Add Prescription Form -->
  <h4 class="mt-5">Add New Prescription</h4>
  <form id="addForm" class="row g-3 mb-5">
    <div class="col-md-4">
      <label class="form-label">Date</label>
      <input type="date" name="prescriptionDate" class="form-control" required>
    </div>
    <div class="col-md-4">
      <label class="form-label">Patient Name</label>
      <input type="text" name="patientName" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Age</label>
      <input type="number" name="patientAge" min="1" max="120" class="form-control" required>
    </div>
    <div class="col-md-2">
      <label class="form-label">Gender</label>
      <select name="patientGender" class="form-select" required>
        <option value="">Choose...</option>
        <option>Male</option>
        <option>Female</option>
      </select>
    </div>
    <div class="col-12">
      <label class="form-label">Diagnosis</label>
      <textarea name="diagnosis" class="form-control"></textarea>
    </div>
    <div class="col-12">
      <label class="form-label">Medicines</label>
      <textarea name="medicines" class="form-control"></textarea>
    </div>
    <div class="col-md-4">
      <label class="form-label">Next Visit (optional)</label>
      <input type="date" name="nextVisitDate" class="form-control">
    </div>
    <div class="col-12">
      <button type="submit" class="btn btn-success">Save</button>
    </div>
  </form>
</div>

<!-- Edit Modal -->
<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Edit Prescription</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="editForm" class="row g-3">
          <input type="hidden" name="id">
          <div class="col-md-6">
            <label class="form-label">Date</label>
            <input type="date" name="prescriptionDate" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Patient Name</label>
            <input type="text" name="patientName" class="form-control" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Age</label>
            <input type="number" name="patientAge" class="form-control" min="1" max="120" required>
          </div>
          <div class="col-md-4">
            <label class="form-label">Gender</label>
            <select name="patientGender" class="form-select" required>
              <option value="">Choose...</option>
              <option>Male</option>
              <option>Female</option>
            </select>
          </div>
          <div class="col-12">
            <label class="form-label">Diagnosis</label>
            <textarea name="diagnosis" class="form-control"></textarea>
          </div>
          <div class="col-12">
            <label class="form-label">Medicines</label>
            <textarea name="medicines" class="form-control"></textarea>
          </div>
          <div class="col-md-6">
            <label class="form-label">Next Visit</label>
            <input type="date" name="nextVisitDate" class="form-control">
          </div>
          <div class="col-12">
            <button type="submit" class="btn btn-success w-100">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
<!-- Middle of the page -->
<div class="text-center my-5">
  <form action="/logout" method="post">
    <button type="submit" class="btn btn-danger btn-lg">Logout</button>
  </form>
</div>



<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiBase = "/api/v1/prescriptions";

// Load prescriptions
async function loadAllPrescriptions(start, end) {
  let url = `${apiBase}`;
  if(start && end) url = `${apiBase}?start=${start}&end=${end}`;
  const data = await (await fetch(url)).json();
  const tbody = document.getElementById("prescriptionTable");
  tbody.innerHTML = "";

  data.forEach(p => {
    tbody.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>${p.prescriptionDate}</td>
        <td>${p.patientName}</td>
        <td>${p.patientAge}</td>
        <td>${p.patientGender}</td>
        <td>${p.diagnosis || ""}</td>
        <td>${p.medicines || ""}</td>
        <td>${p.nextVisitDate || ""}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="editPrescription(${p.id})">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deletePrescription(${p.id})">Delete</button>
        </td>
      </tr>`;
  });

  loadDaywiseReport(start, end);
}

// Day-wise report
async function loadDaywiseReport(start, end) {
  let url = apiBase + "/report/daywise" + (start && end ? `?start=${start}&end=${end}` : "");
  const data = await (await fetch(url)).json();
  const tbody = document.getElementById("daywiseReportTable");
  tbody.innerHTML = "";
  data.forEach(r => {
    tbody.innerHTML += `<tr><td>${r.day}</td><td>${r.count}</td></tr>`;
  });
}

// Filter form
document.getElementById("filterForm").addEventListener("submit", e => {
  e.preventDefault();
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  loadAllPrescriptions(start, end);
});

// Add prescription
document.getElementById("addForm").addEventListener("submit", async e => {
  e.preventDefault();
  const obj = Object.fromEntries(new FormData(e.target).entries());
  obj.patientAge = Number(obj.patientAge);
  if (!obj.nextVisitDate) delete obj.nextVisitDate;
  const res = await fetch(apiBase, { method: "POST", headers: {"Content-Type":"application/json"}, body: JSON.stringify(obj)});
  if(res.ok){ alert("Saved!"); e.target.reset(); loadAllPrescriptions(); }
  else alert("Error saving");
});

// Delete prescription
async function deletePrescription(id) {
  if(!confirm("Delete this prescription?")) return;
  const res = await fetch(`${apiBase}/${id}`, { method: "DELETE" });
  if(res.ok) loadAllPrescriptions();
  else alert("Error deleting");
}

// Edit prescription
function editPrescription(id) {
  fetch(`${apiBase}/${id}`).then(res=>res.json()).then(p=>{
    const form = document.getElementById("editForm");
    form.id.value = p.id;
    form.prescriptionDate.value = p.prescriptionDate;
    form.patientName.value = p.patientName;
    form.patientAge.value = p.patientAge;
    form.patientGender.value = p.patientGender;
    form.diagnosis.value = p.diagnosis||"";
    form.medicines.value = p.medicines||"";
    form.nextVisitDate.value = p.nextVisitDate||"";
    new bootstrap.Modal(document.getElementById('editModal')).show();
  });
}

// Update prescription
document.getElementById("editForm").addEventListener("submit", async e => {
  e.preventDefault();
  const form = e.target;
  const obj = Object.fromEntries(new FormData(form).entries());
  obj.patientAge = Number(obj.patientAge);
  if(!obj.nextVisitDate) delete obj.nextVisitDate;
  const res = await fetch(`${apiBase}/${form.id.value}`, { method:"PUT", headers:{"Content-Type":"application/json"}, body: JSON.stringify(obj)});
  if(res.ok){ bootstrap.Modal.getInstance(document.getElementById('editModal')).hide(); loadAllPrescriptions(); }
  else alert("Error updating");
});

// Default load (current month)
const today = new Date();
const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
document.getElementById("startDate").value = firstDay;
document.getElementById("endDate").value = lastDay;
loadAllPrescriptions(firstDay, lastDay);
</script>
</body>
</html>
