<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Prescription Viewer</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container py-4">
  <h2 class="mb-4 text-center">Prescription Viewer</h2>

  <!-- Navigation -->
  <div class="mb-4 text-end">
    <a href="drug-search.html" class="btn btn-info">üîç Drug Search (RxNav)</a>
  </div>

  <!-- Date Filter -->
  <form id="filterForm" class="row g-2 mb-3">
    <div class="col-md-4">
      <input type="date" id="startDate" class="form-control" required>
    </div>
    <div class="col-md-4">
      <input type="date" id="endDate" class="form-control" required>
    </div>
    <div class="col-md-4">
      <button type="submit" class="btn btn-primary w-100">Filter</button>
    </div>
  </form>

  <!-- Prescription Table -->
  <h4>Prescription List</h4>
  <table class="table table-bordered table-striped">
    <thead class="table-dark">
      <tr>
        <th>ID</th>
        <th>Date</th>
        <th>Patient</th>
        <th>Age</th>
        <th>Gender</th>
        <th>Diagnosis</th>
        <th>Medicines</th>
        <th>Next Visit</th>
      </tr>
    </thead>
    <tbody id="prescriptionTable"></tbody>
  </table>

  <!-- Day-wise Report -->
  <h4 class="mt-5">Day-wise Prescription Count</h4>
  <table class="table table-bordered table-striped">
    <thead class="table-secondary">
      <tr>
        <th>Day</th>
        <th>Prescription Count</th>
      </tr>
    </thead>
    <tbody id="daywiseReportTable"></tbody>
  </table>

  <!-- Logout -->
  <div class="text-center my-5">
    <form action="/logout" method="post">
      <button type="submit" class="btn btn-danger btn-lg">Logout</button>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
const apiBase = "/api/v1/prescriptions";

// Load prescriptions
async function loadAllPrescriptions(start, end) {
  let url = `${apiBase}`;
  if(start && end) url = `${apiBase}?start=${start}&end=${end}`;
  const data = await (await fetch(url)).json();
  const tbody = document.getElementById("prescriptionTable");
  tbody.innerHTML = "";
  data.forEach(p => {
    tbody.innerHTML += `
      <tr>
        <td>${p.id}</td>
        <td>${p.prescriptionDate}</td>
        <td>${p.patientName}</td>
        <td>${p.patientAge}</td>
        <td>${p.patientGender}</td>
        <td>${p.diagnosis || ""}</td>
        <td>${p.medicines || ""}</td>
        <td>${p.nextVisitDate || ""}</td>
      </tr>`;
  });
  loadDaywiseReport(start, end);
}

// Day-wise report
async function loadDaywiseReport(start, end) {
  let url = apiBase + "/report/daywise" + (start && end ? `?start=${start}&end=${end}` : "");
  const data = await (await fetch(url)).json();
  const tbody = document.getElementById("daywiseReportTable");
  tbody.innerHTML = "";
  data.forEach(r => {
    tbody.innerHTML += `<tr><td>${r.day}</td><td>${r.count}</td></tr>`;
  });
}

// Filter form
document.getElementById("filterForm").addEventListener("submit", e => {
  e.preventDefault();
  const start = document.getElementById("startDate").value;
  const end = document.getElementById("endDate").value;
  loadAllPrescriptions(start, end);
});

// Default load (current month)
const today = new Date();
const firstDay = new Date(today.getFullYear(), today.getMonth(), 1).toISOString().split('T')[0];
const lastDay = new Date(today.getFullYear(), today.getMonth() + 1, 0).toISOString().split('T')[0];
document.getElementById("startDate").value = firstDay;
document.getElementById("endDate").value = lastDay;
loadAllPrescriptions(firstDay, lastDay);
</script>
</body>
</html>
